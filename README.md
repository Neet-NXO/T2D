# T2D

ä¸€ä¸ªåŸºäº gnet æ¡†æ¶çš„é«˜æ€§èƒ½ UDP Over TCP è½¬å‘å·¥å…·ï¼Œæ”¯æŒå¤šç§åŠ å¯†ç®—æ³•å’Œçµæ´»çš„é…ç½®é€‰é¡¹ã€‚

## é¡¹ç›®ç®€ä»‹

T2D æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ç½‘ç»œä»£ç†å·¥å…·ï¼Œä¸»è¦åŠŸèƒ½æ˜¯åœ¨ TCP å’Œ UDP åè®®ä¹‹é—´è¿›è¡Œè½¬æ¢å’Œä»£ç†ã€‚å®ƒé‡‡ç”¨äº†é«˜æ€§èƒ½çš„ gnet ç½‘ç»œæ¡†æ¶ï¼Œæ”¯æŒå¤šç§åŠ å¯†ç®—æ³•ï¼Œå¯ä»¥åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´å»ºç«‹å®‰å…¨çš„æ•°æ®ä¼ è¾“é€šé“ã€‚

### ä¸»è¦ç‰¹æ€§

- ğŸš€ **é«˜æ€§èƒ½**: åŸºäº gnet æ¡†æ¶ï¼Œæ”¯æŒé«˜å¹¶å‘è¿æ¥
- ğŸ” **åŒå‘ç‹¬ç«‹åŠ å¯†**: ä¸Šè¡Œå’Œä¸‹è¡Œæ•°æ®æµæ”¯æŒä¸åŒçš„åŠ å¯†ç®—æ³•å’Œå¯†é’¥
- ğŸ”€ **ä¸Šä¸‹è¡Œåˆ†ç¦»**: ç‹¬ç«‹çš„ä¸Šè¡Œå’Œä¸‹è¡Œ TCP è¿æ¥ï¼Œæä¾›æ›´å¥½çš„æ€§èƒ½å’Œå¯é æ€§
- ğŸ›¡ï¸ **å¤šç§åŠ å¯†**: æ”¯æŒ AES-GCMã€ChaCha20-Poly1305 ç­‰å¤šç§åŠ å¯†ç®—æ³•
- ğŸ”§ **çµæ´»é…ç½®**: ä¸°å¯Œçš„é…ç½®é€‰é¡¹ï¼Œæ”¯æŒå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨æ¨¡å¼
- ğŸ“Š **ä¼šè¯ç®¡ç†**: æ™ºèƒ½çš„ UDP ä¼šè¯ç®¡ç†å’Œè¶…æ—¶å¤„ç†
- ğŸ”„ **è‡ªåŠ¨é‡è¿**: æ”¯æŒ TCP è¿æ¥æ–­çº¿è‡ªåŠ¨é‡è¿
- ğŸ“ˆ **è´Ÿè½½å‡è¡¡**: æ”¯æŒå¤šç§è´Ÿè½½å‡è¡¡ç­–ç•¥

## æ¶æ„è®¾è®¡

### æ ¸å¿ƒæ¶æ„ç‰¹æ€§

**ä¸Šä¸‹è¡Œåˆ†ç¦»è®¾è®¡**: T2D é‡‡ç”¨ç‹¬ç«‹çš„ä¸Šè¡Œå’Œä¸‹è¡Œ TCP è¿æ¥ï¼Œè€Œä¸æ˜¯ä¼ ç»Ÿçš„å•ä¸€åŒå‘è¿æ¥ã€‚è¿™ç§è®¾è®¡å¸¦æ¥ä»¥ä¸‹ä¼˜åŠ¿ï¼š

- **æ€§èƒ½ä¼˜åŒ–**: ä¸Šè¡Œå’Œä¸‹è¡Œå¯ä»¥ç‹¬ç«‹ä¼˜åŒ–ï¼Œé¿å…ç›¸äº’å¹²æ‰°
- **çµæ´»é…ç½®**: å¯ä»¥ä¸ºä¸åŒæ–¹å‘é…ç½®ä¸åŒçš„ç½‘ç»œå‚æ•°å’Œè·¯ç”±

**åŒå‘ç‹¬ç«‹åŠ å¯†**: æ”¯æŒä¸Šè¡Œå’Œä¸‹è¡Œä½¿ç”¨å®Œå…¨ä¸åŒçš„åŠ å¯†ç®—æ³•å’Œå¯†é’¥ï¼š

- **å®‰å…¨æ€§å¢å¼º**: å³ä½¿ä¸€ä¸ªæ–¹å‘çš„å¯†é’¥æ³„éœ²ï¼Œå¦ä¸€ä¸ªæ–¹å‘ä»ç„¶å®‰å…¨
- **æ€§èƒ½å¹³è¡¡**: å¯ä»¥æ ¹æ®æ•°æ®ç‰¹æ€§é€‰æ‹©æœ€é€‚åˆçš„åŠ å¯†ç®—æ³•
- **çµæ´»éƒ¨ç½²**: é€‚åº”ä¸åŒçš„å®‰å…¨éœ€æ±‚å’Œç½‘ç»œç¯å¢ƒ

### æ•°æ®æµå›¾

```
å®¢æˆ·ç«¯æ¨¡å¼ (ä¸Šä¸‹è¡Œåˆ†ç¦»):
                    â”Œâ”€ ä¸Šè¡ŒTCPè¿æ¥(åŠ å¯†A) â”€â”
UDPåº”ç”¨ <--UDP--> T2Då®¢æˆ·ç«¯                    T2DæœåŠ¡å™¨ <--UDP--> åç«¯æœåŠ¡
                    â””â”€ ä¸‹è¡ŒTCPè¿æ¥(åŠ å¯†B) â”€â”˜

æœåŠ¡å™¨æ¨¡å¼:
                    â”Œâ”€ ä¸Šè¡ŒTCPç›‘å¬:9001(åŠ å¯†A) â”€â”
å®¢æˆ·ç«¯                                           T2DæœåŠ¡å™¨ <--UDP--> åç«¯UDPæœåŠ¡
                    â””â”€ ä¸‹è¡ŒTCPç›‘å¬:9002(åŠ å¯†B) â”€â”˜
```

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Go 1.24.3 æˆ–æ›´é«˜ç‰ˆæœ¬
- Linux/macOS/Windows æ“ä½œç³»ç»Ÿ

### å®‰è£…

1. å…‹éš†é¡¹ç›®
```bash
git clone <repository-url>
cd T2D
```

2. æ„å»ºé¡¹ç›®
```bash
make build
```

æˆ–è€…ç›´æ¥ä½¿ç”¨ Go å‘½ä»¤ï¼š
```bash
go build -o build/T2D ./cmd/T2D
```

### é…ç½®æ–‡ä»¶

é¡¹ç›®æä¾›äº†ä¸¤ä¸ªç¤ºä¾‹é…ç½®æ–‡ä»¶ï¼š

- `client_config.json` - å®¢æˆ·ç«¯é…ç½®
- `server_config.json` - æœåŠ¡å™¨é…ç½®

### è¿è¡Œ

#### å¯åŠ¨æœåŠ¡å™¨
```bash
make run-server
# æˆ–è€…
./build/T2D -config server_config.json
```

#### å¯åŠ¨å®¢æˆ·ç«¯
```bash
make run-client
# æˆ–è€…
./build/T2D -config client_config.json
```

## é…ç½®è¯´æ˜

### åŸºç¡€é…ç½®

| å‚æ•° | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|------|
| `mode` | string | æ˜¯ | è¿è¡Œæ¨¡å¼ï¼š"client" æˆ– "server" |
| `log_level` | string | å¦ | æ—¥å¿—çº§åˆ«ï¼š"debug", "info", "warn", "error" |
| `session_timeout` | int | å¦ | UDPä¼šè¯è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤300 |
| `reconnect_interval` | int | å¦ | TCPé‡è¿é—´éš”ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤5 |

### å®¢æˆ·ç«¯é…ç½®

| å‚æ•° | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|------|
| `listen_addr` | string | æ˜¯ | UDPç›‘å¬åœ°å€ï¼Œå¦‚ "0.0.0.0:51820" |
| `server_upstream` | string | æ˜¯ | æœåŠ¡å™¨ä¸Šè¡Œåœ°å€ï¼Œå¦‚ "192.168.1.100:9001" |
| `server_downstream` | string | æ˜¯ | æœåŠ¡å™¨ä¸‹è¡Œåœ°å€ï¼Œå¦‚ "192.168.1.100:9002" |

### æœåŠ¡å™¨é…ç½®

| å‚æ•° | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|------|
| `upstream_port` | string | æ˜¯ | ä¸Šè¡Œç›‘å¬ç«¯å£ï¼Œå¦‚ ":9001" |
| `downstream_port` | string | æ˜¯ | ä¸‹è¡Œç›‘å¬ç«¯å£ï¼Œå¦‚ ":9002" |
| `backend_addr` | string | æ˜¯ | åç«¯UDPåœ°å€ï¼Œå¦‚ "127.0.0.1:51820" |

### åŠ å¯†é…ç½®

#### åŒå‘ç‹¬ç«‹åŠ å¯†

T2D çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€æ˜¯æ”¯æŒä¸Šè¡Œå’Œä¸‹è¡Œæ•°æ®æµä½¿ç”¨å®Œå…¨ç‹¬ç«‹çš„åŠ å¯†é…ç½®ï¼š

```json
{
  "upstream_crypto": {
    "type": "aes-256-gcm",
    "password": "upstream-secret-key-2024"
  },
  "downstream_crypto": {
    "type": "chacha20-poly1305",
    "password": "downstream-secret-key-2024"
  }
}
```

**é‡è¦è¯´æ˜**:
- **ä¸Šè¡ŒåŠ å¯†**: å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨æ–¹å‘çš„æ•°æ®åŠ å¯†
- **ä¸‹è¡ŒåŠ å¯†**: æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯æ–¹å‘çš„æ•°æ®åŠ å¯†
- **ç‹¬ç«‹å¯†é’¥**: ä¸Šè¡Œå’Œä¸‹è¡Œå¯ä»¥ä½¿ç”¨å®Œå…¨ä¸åŒçš„å¯†ç å’Œç®—æ³•
- **é…ç½®åŒ¹é…**: å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„åŠ å¯†é…ç½®å¿…é¡»å®Œå…¨ä¸€è‡´

#### åŠ å¯†é…ç½®ç¤ºä¾‹

**é«˜å®‰å…¨æ€§é…ç½®** (ä¸åŒç®—æ³•+ä¸åŒå¯†é’¥):
```json
{
  "upstream_crypto": {
    "type": "aes-256-gcm",
    "password": "AES-upstream-key-32chars-long!!!"
  },
  "downstream_crypto": {
    "type": "xchacha20-poly1305",
    "password": "XChaCha20-downstream-key-secure"
  }
}
```

**æ€§èƒ½ä¼˜åŒ–é…ç½®** (å¿«é€Ÿç®—æ³•):
```json
{
  "upstream_crypto": {
    "type": "chacha20-poly1305",
    "password": "fast-upstream-encryption-key"
  },
  "downstream_crypto": {
    "type": "chacha20-poly1305",
    "password": "fast-downstream-encryption-key"
  }
}
```

**æ— åŠ å¯†é…ç½®** (æ˜æ–‡ä¼ è¾“):
```json
{
  "upstream_crypto": {
    "type": "none"
  },
  "downstream_crypto": {
    "type": "none"
  }
}
```

#### æ”¯æŒçš„åŠ å¯†ç®—æ³•

- `none` - æ— åŠ å¯†
- `xor` - XORæ··æ·†
- `aes-128-gcm` - AES-128-GCM
- `aes-256-gcm` - AES-256-GCM
- `chacha20-poly1305` - ChaCha20-Poly1305
- `xchacha20-poly1305` - XChaCha20-Poly1305

### æ€§èƒ½è°ƒä¼˜é…ç½®

```json
{
  "multicore": true,
  "load_balancing": "least_connections",
  "socket_recv_buffer": 65536,
  "socket_send_buffer": 65536,
  "tcp_keep_alive": 30,
  "tcp_no_delay": true
}
```

## ä½¿ç”¨åœºæ™¯

### 1. WireGuard ä»£ç†

å°† WireGuard UDP æµé‡é€šè¿‡ TCP ä¼ è¾“ï¼Œé€‚ç”¨äºé™åˆ¶ UDP çš„ç½‘ç»œç¯å¢ƒï¼š

```bash
# æœåŠ¡å™¨ç«¯
./T2D -config server_config.json

# å®¢æˆ·ç«¯
./T2D -config client_config.json

# WireGuard å®¢æˆ·ç«¯è¿æ¥åˆ° T2D å®¢æˆ·ç«¯çš„ç›‘å¬åœ°å€
wg-quick up wg0  # é…ç½® endpoint ä¸º 127.0.0.1:51820
```

### 2. æ¸¸æˆåŠ é€Ÿ

ä¸º UDP æ¸¸æˆæµé‡æä¾› TCP é€šé“å’ŒåŠ å¯†ï¼š

```json
{
  "mode": "client",
  "listen_addr": "0.0.0.0:7777",
  "server_upstream": "game-server.com:9001",
  "server_downstream": "game-server.com:9002",
  "upstream_crypto": {
    "type": "chacha20-poly1305",
    "password": "game-secret-key"
  }
}
```

### 3. DNS over TCP

å°† DNS UDP æŸ¥è¯¢è½¬æ¢ä¸º TCP ä¼ è¾“ï¼š

```json
{
  "mode": "server",
  "upstream_port": ":5353",
  "downstream_port": ":5354",
  "backend_addr": "8.8.8.8:53"
}
```

## å¼€å‘

### é¡¹ç›®ç»“æ„

```
T2D/
â”œâ”€â”€ cmd/t2d/           # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ app/           # åº”ç”¨ç¨‹åºé€»è¾‘
â”‚   â”œâ”€â”€ client/        # å®¢æˆ·ç«¯å®ç°
â”‚   â”œâ”€â”€ server/        # æœåŠ¡å™¨å®ç°
â”‚   â”œâ”€â”€ config/        # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ crypto/        # åŠ å¯†æ¨¡å—
â”‚   â”œâ”€â”€ protocol/      # åè®®å®šä¹‰
â”‚   â”œâ”€â”€ session/       # ä¼šè¯ç®¡ç†
â”‚   â””â”€â”€ stats/         # ç»Ÿè®¡ä¿¡æ¯
â”œâ”€â”€ client_config.json # å®¢æˆ·ç«¯é…ç½®ç¤ºä¾‹
â”œâ”€â”€ server_config.json # æœåŠ¡å™¨é…ç½®ç¤ºä¾‹
â”œâ”€â”€ CONFIG_GUIDE.md    # è¯¦ç»†é…ç½®æŒ‡å—
â”œâ”€â”€ CRYPTO_README.md   # åŠ å¯†åŠŸèƒ½è¯´æ˜
â””â”€â”€ Makefile          # æ„å»ºè„šæœ¬
```

### å¯ç”¨çš„ Make å‘½ä»¤

```bash
make build          # æ„å»ºé¡¹ç›®
make clean          # æ¸…ç†æ„å»ºæ–‡ä»¶
make run-client     # è¿è¡Œå®¢æˆ·ç«¯
make run-server     # è¿è¡ŒæœåŠ¡å™¨
make fmt            # æ ¼å¼åŒ–ä»£ç 
make vet            # ä»£ç æ£€æŸ¥
make test           # è¿è¡Œæµ‹è¯•
make install        # å®‰è£…åˆ°ç³»ç»Ÿ
```

### ä¾èµ–é¡¹

- [gnet/v2](https://github.com/panjf2000/gnet) - é«˜æ€§èƒ½ç½‘ç»œæ¡†æ¶
- [golang.org/x/crypto](https://golang.org/x/crypto) - Go åŠ å¯†åº“

## æ€§èƒ½ç‰¹æ€§

- **é«˜å¹¶å‘**: åŸºäº gnet çš„äº‹ä»¶é©±åŠ¨æ¶æ„
- **å†…å­˜ä¼˜åŒ–**: é›¶æ‹·è´å’Œå¯¹è±¡æ± æŠ€æœ¯
- **è´Ÿè½½å‡è¡¡**: æ”¯æŒå¤šç§è´Ÿè½½å‡è¡¡ç­–ç•¥
- **è¿æ¥å¤ç”¨**: TCP è¿æ¥å¤ç”¨å’Œä¿æ´»
- **ç¼“å†²ä¼˜åŒ–**: å¯é…ç½®çš„è¯»å†™ç¼“å†²åŒº

## å®‰å…¨ç‰¹æ€§

- **ç«¯åˆ°ç«¯åŠ å¯†**: æ”¯æŒå¤šç§ç°ä»£åŠ å¯†ç®—æ³•
- **å¯†é’¥ç®¡ç†**: å®‰å…¨çš„å¯†é’¥æ´¾ç”Ÿå’Œç®¡ç†
- **ä¼šè¯éš”ç¦»**: ç‹¬ç«‹çš„ä¼šè¯ç®¡ç†å’Œè¶…æ—¶
- **é˜²é‡æ”¾**: åºåˆ—å·å’Œæ—¶é—´æˆ³éªŒè¯

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è¿æ¥å¤±è´¥**
   - æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
   - éªŒè¯é…ç½®æ–‡ä»¶ä¸­çš„åœ°å€å’Œç«¯å£
   - ç¡®è®¤æœåŠ¡å™¨ç«¯å·²å¯åŠ¨

2. **åŠ å¯†é”™è¯¯**
   - ç¡®ä¿å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä½¿ç”¨ç›¸åŒçš„åŠ å¯†é…ç½®
   - æ£€æŸ¥å¯†ç æ˜¯å¦åŒ¹é…
   - éªŒè¯åŠ å¯†ç®—æ³•æ˜¯å¦æ”¯æŒ

3. **æ€§èƒ½é—®é¢˜**
   - è°ƒæ•´ç¼“å†²åŒºå¤§å°
   - å¯ç”¨å¤šæ ¸æ¨¡å¼
   - ä¼˜åŒ–è´Ÿè½½å‡è¡¡ç­–ç•¥

### æ—¥å¿—åˆ†æ

å¯ç”¨è¯¦ç»†æ—¥å¿—ï¼š
```json
{
  "log_level": "debug",
  "log_path": "/var/log/t2d.log"
}
```

## è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ Apache License 2.0 è®¸å¯è¯ã€‚è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

```
Copyright 2024 T2D-GNET Contributors

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
```

## æ›´å¤šæ–‡æ¡£

- [è¯¦ç»†é…ç½®æŒ‡å—](CONFIG_GUIDE.md)
- [åŠ å¯†åŠŸèƒ½è¯´æ˜](CRYPTO_README.md)